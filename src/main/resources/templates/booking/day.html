<!DOCTYPE html>
<html lang="th" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::section})}">
<section class="container py-4">

  <h1 class="h3 mb-2 text-center" style="color:#c2185b;"
      th:text="${title} ?: 'เลือกช่วงเวลา'">เลือกช่วงเวลา</h1>
  <p class="text-center text-muted mb-4">
    วันที่: <b th:text="${date}">-</b>
  </p>

  <div class="table-responsive shadow-sm rounded">
    <table id="slots" class="table table-bordered table-striped align-middle text-center mb-0">
      <thead class="table-light">
        <tr>
          <th>เวลา</th>
          <th>ช่าง</th>
          <th>เหลือ/ทั้งหมด</th>
          <th>จอง</th>
        </tr>
      </thead>
      <tbody>
        <!-- first paint จากเซิร์ฟเวอร์ -->
        <tr th:each="s : ${slots}"
            th:with="remain=${s.remaining} == null ? s.capacity : s.remaining">
          <td th:text="${#temporals.format(s.startAt,'HH:mm')} + ' - ' + #temporals.format(s.endAt,'HH:mm')">--:-- - --:--</td>
          <td th:text="${s.techName}">-</td>
          <td>
            <b th:text="${remain}">0</b>/<span th:text="${s.capacity}">0</span>
          </td>
          <td>
            <form action="/booking/confirm" method="get">
              <input type="hidden" name="slotId" th:value="${s.id}">
              <input type="hidden" name="serviceId" th:value="${serviceId}">
              <button type="submit"
                      class="btn btn-sm"
                      th:classappend="${remain} == 0 ? ' btn-secondary' : ' btn-outline-primary'"
                      th:attr="disabled=${remain} == 0 ? 'disabled' : null">
                <span th:text="${remain} == 0 ? 'เต็ม' : 'จอง'">จอง</span>
              </button>
            </form>
          </td>
        </tr>

        <!-- กรณีว่าง -->
        <tr th:if="${#lists.isEmpty(slots)}">
          <td colspan="4" class="text-muted py-3">— ไม่มีสลอตในวันดังกล่าว —</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="text-center mt-4">
    <a class="btn btn-outline-secondary" href="/booking/services">← กลับไปเลือกบริการ</a>
  </div>

  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .65rem .75rem; vertical-align: middle; }
    tr:hover { background-color: #fff0f6; }
    .btn-outline-primary { border: 1px solid #c2185b; color: #c2185b; transition: all .2s; }
    .btn-outline-primary:hover { background: #c2185b; color: #fff; }
    .btn-secondary { background:#6c757d; color:#fff; border:none; cursor:not-allowed; }
    @media(max-width:768px){
      th, td { font-size:.85rem; padding:.5rem; }
      .btn-sm { font-size:.75rem; padding:.35rem .5rem; }
    }
  </style>

  <!-- ปิด inline เพื่อกัน Thymeleaf ไปยุ่งกับ ${} ใน JS -->
  <script th:inline="none">
  (async () => {
    try {
      const params = new URLSearchParams(location.search);
      let date = params.get('date');
      const serviceId = params.get('serviceId');
      if (!date) {
        const today = new Date();
        const pad = n => String(n).toString().padStart(2,'0');
        date = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
      }

      const res = await fetch(`/booking/slots?${new URLSearchParams({date, serviceId})}`);
      if (!res.ok) return;
      const payload = await res.json();
      const slots = Array.isArray(payload.slots) ? payload.slots : [];
      if (slots.length === 0) return;

      const tb = document.querySelector('#slots tbody');
      if (!tb) return;
      tb.innerHTML = '';
      const fmt = d => new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      slots.forEach(s => {
        const tr = document.createElement('tr');
        const remain = (s.remaining ?? s.capacity ?? 0);
        tr.innerHTML = `
          <td>${fmt(s.startAt)} - ${fmt(s.endAt)}</td>
          <td>${s.techName ?? '-'}</td>
          <td><b>${remain}</b>/${s.capacity ?? 0}</td>
          <td>
            <form action="/booking/confirm" method="get">
              <input type="hidden" name="slotId" value="${s.id}">
              <input type="hidden" name="serviceId" value="${serviceId}">
              <button type="submit" class="btn btn-sm ${remain === 0 ? 'btn-secondary' : 'btn-outline-primary'}"
                      ${remain === 0 ? 'disabled' : ''}>
                ${remain === 0 ? 'เต็ม' : 'จอง'}
              </button>
            </form>
          </td>
        `;
        tb.appendChild(tr);
      });
    } catch (e) {
      console.warn('ไม่สามารถโหลดข้อมูล slot สดได้', e);
    }
  })();
  </script>

</section>
</html>
