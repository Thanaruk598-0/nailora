<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="th"
      th:replace="~{layout :: layout(~{::section})}">
<section>
  <h1 th:text="${title} ?: 'เลือกช่วงเวลา'">เลือกช่วงเวลา</h1>
  <p>วันที่: <b th:text="${date}">-</b></p>

  <table id="slots" border="1" cellspacing="0" cellpadding="6">
    <thead><tr><th>เวลา</th><th>ช่าง</th><th>เหลือ/ทั้งหมด</th><th>จอง</th></tr></thead>
    <tbody>
      <tr><td colspan="4">กำลังโหลด...</td></tr>
    </tbody>
  </table>

  <p style="margin-top:12px;"><a href="/booking/services">← กลับ</a></p>

  <script>
  (async () => {
    const params = new URLSearchParams(location.search);
    const date = params.get('date');
    const serviceId = params.get('serviceId');

    const r = await fetch(`/booking/slots?${new URLSearchParams({date, serviceId})}`);
    const { slots=[] } = await r.json().catch(()=>({slots:[]}));

    const tb = document.querySelector('#slots tbody');
    tb.innerHTML = '';
    const fmt = (d)=> new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    if (!slots.length) {
      tb.innerHTML = '<tr><td colspan="4">— ไม่มีสลอต —</td></tr>';
      return;
    }

    slots.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmt(s.startAt)} - ${fmt(s.endAt)}</td>
        <td>${s.techName}</td>
        <td><b>${s.remaining}</b>/${s.capacity}</td>
        <td>
          <form action="/booking/confirm" method="get">
            <input type="hidden" name="slotId" value="${s.id}">
            <input type="hidden" name="serviceId" value="${serviceId}">
            <button type="submit" ${s.remaining === 0 ? 'disabled' : ''}>
              ${s.remaining === 0 ? 'เต็ม' : 'จอง'}
            </button>
          </form>
        </td>
      `;
      tb.appendChild(tr);
    });
  })();
  </script>
</section>
</html>
