<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::section})}">
<head th:fragment="head">
  <title>Admin ‚Ä¢ Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fffafb;
      color: #444;
      margin:0;
      padding:0;
    }

    h1 { color:#c2185b; text-align:center; margin:1.5rem 0; font-size:2rem; }
    h2 { font-size:1.4rem; color:#c2185b; margin:1.5rem 0 .5rem; border-bottom:1px solid #f3c6d3; padding-bottom:.3rem; }

    /* --- Summary Cards --- */
    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1rem;
      margin:2rem 1rem;
    }
    .card {
      background:linear-gradient(135deg,#ff80ab,#ffc1d3);
      border-radius:1rem;
      padding:1.2rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      text-align:center;
      transition: transform .3s, box-shadow .3s;
    }
    .card:hover { transform:translateY(-4px); box-shadow:0 8px 16px rgba(0,0,0,0.2); }
    .card h2 { margin:0.5rem 0 0; font-size:1.8rem; color:#880e4f; }
    .card span { font-size:.95rem; color:#fff; font-weight:500; }

    section { margin:2rem 1rem; }

    /* --- Charts --- */
    #lineChart, #pieChart {
      background:#fff;
      padding:1rem;
      border-radius:1rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      display:block;
      margin:1rem auto;
    }
    #lineChart { width:100%; max-width:1000px; height:500px; }
    #pieChart { width:100%; max-width:400px; height:300px; }

    /* --- Recent Bookings Table --- */
    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border-radius:1rem;
      overflow:hidden;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      background:#fff;
    }
    th, td {
      padding:.8rem;
      font-size:.9rem;
      text-align:center;
      border-bottom:1px solid #f3c6d3;
    }
    th {
      background:linear-gradient(135deg,#f48fb1,#f06292);
      color:#fff;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:nth-child(even){ background:#fff0f6; }
    tr:hover { background:#ffe4f0; transform:translateX(2px); transition:.2s; }
    td:first-child { border-top-left-radius:1rem; border-bottom-left-radius:1rem; }
    td:last-child { border-top-right-radius:1rem; border-bottom-right-radius:1rem; }

    /* --- Export Buttons --- */
    .export-buttons { margin:1rem 0; text-align:right; }
    .export-buttons button {
      background:#f48fb1;
      border:none;
      border-radius:.5rem;
      padding:.5rem 1rem;
      margin-left:.3rem;
      color:#fff;
      font-weight:500;
      cursor:pointer;
      transition:.3s;
    }
    .export-buttons button:hover { background:#c2185b; }

    @media(max-width:768px){
      table th, table td { font-size:.8rem; padding:.5rem; }
      .card h2 { font-size:1.5rem; }
      .card span { font-size:.85rem; }
    }
    @media(max-width:480px){
      table { display:block; overflow-x:auto; white-space:nowrap; }
      .cards { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
<main>
  <h1>üíÖ Reports Dashboard</h1>

  <section class="cards">
    <div class="card"><h2 id="summaryBookings">0</h2><span>Total Bookings</span></div>
    <div class="card"><h2 id="summaryRevenue">‡∏ø0</h2><span>Total Revenue</span></div>
    <div class="card"><h2 id="summaryCancelled">0</h2><span>Cancelled</span></div>
  </section>

  <section>
    <h2>üìà Bookings & Revenue</h2>
    <canvas id="lineChart"></canvas>
  </section>

  <section>
    <h2>üíñ Top Services</h2>
    <canvas id="pieChart"></canvas>
  </section>

  <section>
    <h2>üìù Recent Bookings</h2>
    <div class="export-buttons">
      <button id="btnExportExcel">Export Excel</button>
    </div>
    <table id="tblBookings">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Service</th>
          <th>Service Price</th>
          <th>Add-on Price</th>
          <th>Total</th>
          <th>Status</th>
          <th>Deposit</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script src="/js/common.js"></script>
  <script>
    (async function(){
      const bookings = await api.get("/admin/api/bookings");
      const totalBookings = bookings.length;
      const totalRevenue = bookings.reduce((sum, b) => sum + Number(b.servicePrice||0) + Number(b.addOnPrice||0), 0);
      const cancelled = bookings.filter(b => b.status==='CANCELLED').length;

      document.querySelector("#summaryBookings").textContent = totalBookings;
      document.querySelector("#summaryRevenue").textContent = "‡∏ø" + totalRevenue.toFixed(2);
      document.querySelector("#summaryCancelled").textContent = cancelled;

      const tbody = document.querySelector("#tblBookings tbody");
      tbody.innerHTML = bookings.map(b => `
        <tr>
          <td>${b.id}</td>
          <td>${b.customerName}</td>
          <td>${b.phone}</td>
          <td>${b.timeSlot?.serviceItem?.name||'-'}</td>
          <td>‡∏ø${Number(b.servicePrice).toFixed(2)}</td>
          <td>‡∏ø${Number(b.addOnPrice).toFixed(2)}</td>
          <td>‡∏ø${(Number(b.servicePrice)+Number(b.addOnPrice)).toFixed(2)}</td>
          <td>${b.status}</td>
          <td>${b.depositStatus}</td>
          <td>${b.createdAt?new Date(b.createdAt).toLocaleString():'-'}</td>
        </tr>
      `).join('');

      const daily={};
      bookings.forEach(b=>{
        const day=b.createdAt?b.createdAt.substring(0,10):"Unknown";
        if(!daily[day]) daily[day]={revenue:0,count:0};
        daily[day].revenue+=Number(b.servicePrice||0)+Number(b.addOnPrice||0);
        daily[day].count++;
      });
      const labels=Object.keys(daily).sort();
      const revenues=labels.map(d=>daily[d].revenue);
      const counts=labels.map(d=>daily[d].count);

      new Chart(document.querySelector("#lineChart"),{
        type:'line',
        data:{labels,datasets:[
          {label:'Revenue (‡∏ø)',data:revenues,borderColor:'#c2185b',backgroundColor:'#f8bbd0',fill:true,tension:0.3},
          {label:'Bookings',data:counts,borderColor:'#f48fb1',backgroundColor:'#fce4ec',fill:true,tension:0.3}
        ]},
        options:{responsive:true,plugins:{legend:{position:'top'}}}
      });

      const serviceSummary={};
      bookings.forEach(b=>{
        const key=b.timeSlot?.serviceItem?.name||"Unknown";
        if(!serviceSummary[key]) serviceSummary[key]=0;
        serviceSummary[key]+=Number(b.servicePrice||0);
      });
      new Chart(document.querySelector("#pieChart"),{
        type:'pie',
        data:{
          labels:Object.keys(serviceSummary),
          datasets:[{data:Object.values(serviceSummary),
                     backgroundColor:["#c2185b","#f48fb1","#f8bbd0","#fce4ec"]}]
        },
        options:{responsive:true,plugins:{legend:{position:'bottom'}}}
      });

      document.querySelector("#btnExportExcel").addEventListener("click",()=>{
        const wb=XLSX.utils.table_to_book(document.getElementById("tblBookings"),{sheet:"Bookings"});
        XLSX.writeFile(wb,"bookings_report.xlsx");
      });
    })();
  </script>
</main>
</body>
</html>
