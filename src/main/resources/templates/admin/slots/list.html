<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="th"
      th:replace="~{layout :: layout(~{::section})}">
<section>
  <style>
    /* --- Reset & Body --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family:'Segoe UI', sans-serif; background:#fff5f8; color:#333; line-height:1.6; }

    h1, h3 { text-align:center; margin-bottom:1rem; }
    h1 { color:#d81b60; font-size:2rem; }
    h3 { color:#ad1457; font-size:1.2rem; margin-top:2rem; }

    /* --- Forms --- */
    form { margin-bottom:1rem; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center; justify-content:center; }
    form label { display:flex; flex-direction:column; font-size:.9rem; color:#555; }
    input, select, button { padding:.5rem .8rem; border:1px solid #ddd; border-radius:.5rem; font-size:.9rem; transition:.3s; }
    input:focus, select:focus { outline:none; border-color:#d81b60; box-shadow:0 0 5px rgba(216,27,96,.3); }
    button { background:#f06292; border:none; color:#fff; cursor:pointer; border-radius:.5rem; transition:.3s; }
    button:hover { background:#d81b60; }

    /* --- Card Styling for Forms --- */
    form[action="/admin/slots/generate"] { background:#ffe4ec; padding:1rem; border-radius:1rem; box-shadow:0 4px 8px rgba(0,0,0,0.05); max-width:600px; margin:0 auto; }

    /* --- Table --- */
    table { width:100%; border-collapse:collapse; margin-top:1rem; border-radius:.8rem; overflow:hidden; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
    th, td { padding:.8rem; text-align:center; font-size:.9rem; }
    th { background:#f48fb1; color:#880e4f; font-weight:600; }
    tr:nth-child(even) { background:#fff0f6; }
    tr:hover { background:#ffd6e8; }

    /* --- Badge --- */
    .badge { padding:.2rem .6rem; border-radius:.6rem; font-size:.8rem; font-weight:500; color:#fff; }
    .badge.open { background:#4caf50; }
    .badge.closed { background:#f44336; }

    /* --- Delete Button --- */
    form[action*="/delete"] button { background:#f44336; }
    form[action*="/delete"] button:hover { background:#d32f2f; }

    /* --- Links --- */
    a { color:#d81b60; text-decoration:none; }
    a:hover { text-decoration:underline; }

    /* --- Responsive --- */
    @media (max-width:768px){
      form { flex-direction:column; align-items:stretch; }
      th, td { font-size:.8rem; padding:.5rem; }
      form[action="/admin/slots/generate"] { max-width:100%; }
    }
  </style>

  <h1 th:text="${title} ?: 'จัดการสลอต (แอดมิน)'">จัดการสลอต (แอดมิน)</h1>

  <!-- ฟอร์มค้นหา -->
  <form method="get" action="/admin/slots">
    <label>วันที่: <input type="date" name="date" th:value="${date}"></label>
    <label>บริการ:
      <select name="serviceId">
        <option th:each="s: ${services}" th:value="${s.id}"
                th:selected="${serviceId} == ${s.id}"
                th:text="${s.name}">svc</option>
      </select>
    </label>
    <button type="submit">ค้นหา</button>
  </form>

  <!-- ฟอร์มสร้างสลอต -->
  <h3>สร้างสลอตเป็นชุด</h3>
  <form method="post" action="/admin/slots/generate">
    <input type="hidden" name="serviceId" th:value="${serviceId}">
    <input type="hidden" name="date" th:value="${date}">
    <label>เวลาเริ่ม: <input type="time" name="fromTime" value="10:00" required></label>
    <label>เวลาสิ้นสุด: <input type="time" name="toTime" value="19:00" required></label>
    <label>ความยาว(นาที): <input type="number" name="durationMin" value="60" min="10" max="600" required></label>
    <label>ช่องไฟ(นาที): <input type="number" name="gapMin" value="0" min="0" max="120"></label>
    <label>ความจุ: <input type="number" name="capacity" value="1" min="1" required></label>
    <label>ช่าง: <input type="text" name="techName" value="Mint"></label>
    <label>เปิดสลอต: <input type="checkbox" name="open" value="true" checked></label>
    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <button type="submit">สร้าง</button>
  </form>

  <!-- ตารางสลอต -->
  <h3 style="margin-top:12px;">สลอตของวัน</h3>
  <table>
    <thead>
      <tr><th>#</th><th>เวลา</th><th>ช่าง</th><th>ความจุ</th><th>เปิด</th><th>จัดการ</th></tr>
    </thead>
    <tbody>
      <tr th:each="t, i: ${slots}">
        <td th:text="${i.count}">1</td>
        <td th:text="${#temporals.format(t.startAt,'HH:mm')} + ' - ' + ${#temporals.format(t.endAt,'HH:mm')}">-</td>
        <td th:text="${t.techName}">-</td>
        <td th:text="${t.capacity}">1</td>
        <td>
          <span th:classappend="${t.open} ? 'badge open' : 'badge closed'"
                th:text="${t.open} ? 'เปิด' : 'ปิด'">เปิด</span>
        </td>
        <td>
          <form th:action="@{'/admin/slots/' + ${t.id} + '/delete'}" method="post" style="display:inline;">
            <input type="hidden" name="date" th:value="${date}">
            <input type="hidden" name="serviceId" th:value="${serviceId}">
            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" onclick="return confirm('ลบสลอตนี้?')">ลบ</button>
          </form>
        </td>
      </tr>
      <tr th:if="${#lists.isEmpty(slots)}">
        <td colspan="6">— ยังไม่มีสลอต —</td>
      </tr>
    </tbody>
  </table>

  <p style="margin-top:12px;"><a href="/booking/services">← ไปหน้าลูกค้า</a></p>

  <script>
    (function(){
      function toCE(yyyyMmDd){
        if(!yyyyMmDd) return yyyyMmDd;
        const [y,m,d] = yyyyMmDd.split('-').map(Number);
        const y2 = (y>2200) ? y-543 : y;
        return [y2,String(m).padStart(2,'0'),String(d).padStart(2,'0')].join('-');
      }
      const searchForm = document.querySelector('form[action="/admin/slots"]');
      if (searchForm) searchForm.addEventListener('submit', ()=> {
        const dateEl = searchForm.querySelector('input[name="date"]');
        if (dateEl && dateEl.value) dateEl.value = toCE(dateEl.value);
      });
      const genForm = document.querySelector('form[action="/admin/slots/generate"]');
      if (genForm) genForm.addEventListener('submit', ()=> {
        const hiddenDate = genForm.querySelector('input[type="hidden"][name="date"]');
        if (hiddenDate && hiddenDate.value) hiddenDate.value = toCE(hiddenDate.value);
      });
    })();
  </script>
</section>
</html>
